<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; font-size: 13px; padding: 16px; color: #202124; }
    p.subtitle { margin-bottom: 12px; color: #555; }

    .table-wrap { max-height: 310px; overflow-y: auto; border: 1px solid #dadce0; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: #4285f4; color: #fff; padding: 8px 10px;
      text-align: left; position: sticky; top: 0; z-index: 1;
    }
    thead th:first-child { width: 36px; text-align: center; }
    tbody tr:nth-child(even) { background: #f8f9fa; }
    tbody tr:hover { background: #e8f0fe; }
    tbody td { padding: 7px 10px; border-bottom: 1px solid #f1f3f4; }
    tbody td:first-child { text-align: center; }

    .no-data { text-align: center; padding: 24px; color: #888; }

    .footer {
      margin-top: 14px; display: flex; justify-content: flex-end;
      align-items: center; gap: 8px;
    }
    .btn {
      padding: 7px 20px; border: none; border-radius: 4px;
      cursor: pointer; font-size: 13px; font-weight: 500;
    }
    .btn-primary { background: #4285f4; color: #fff; }
    .btn-primary:disabled { background: #a8c7fa; cursor: not-allowed; }
    .btn-cancel { background: #f1f3f4; color: #3c4043; }
    .btn-cancel:hover { background: #e8eaed; }

    #status { font-size: 12px; color: #888; margin-right: auto; }
  </style>
</head>
<body>
  <p class="subtitle">Select the customer(s) to restore to the TRACKER sheet:</p>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" title="Select all"></th>
          <th>Company Name</th>
          <th>Contract Start</th>
          <th>Contract End</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="footer">
    <span id="status"></span>
    <button class="btn btn-cancel" onclick="google.script.host.close()">Cancel</button>
    <button class="btn btn-primary" id="restoreBtn" onclick="restore()" disabled>Restore Selected</button>
  </div>

  <script>
    const companies = <?!= companies ?>;

    const tbody      = document.getElementById('tableBody');
    const selectAll  = document.getElementById('selectAll');
    const restoreBtn = document.getElementById('restoreBtn');
    const statusEl   = document.getElementById('status');

    if (!companies || companies.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="no-data">No archived customers found.</td></tr>';
    } else {
      companies.forEach(function(c) {
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td><input type="checkbox" class="rowCheck" value="' + c.index + '"></td>' +
          '<td>' + escHtml(c.name || '—') + '</td>' +
          '<td>' + escHtml(c.contractStart || '—') + '</td>' +
          '<td>' + escHtml(c.contractEnd   || '—') + '</td>';
        tbody.appendChild(tr);
      });

      tbody.addEventListener('change', updateState);
    }

    selectAll.addEventListener('change', function() {
      document.querySelectorAll('.rowCheck').forEach(function(cb) {
        cb.checked = selectAll.checked;
      });
      updateState();
    });

    function updateState() {
      const checked = getChecked();
      restoreBtn.disabled = checked.length === 0;
      statusEl.textContent = checked.length > 0
        ? checked.length + ' selected'
        : '';
      const allBoxes = document.querySelectorAll('.rowCheck');
      selectAll.indeterminate = checked.length > 0 && checked.length < allBoxes.length;
      selectAll.checked = checked.length === allBoxes.length && allBoxes.length > 0;
    }

    function getChecked() {
      return Array.from(document.querySelectorAll('.rowCheck:checked'))
        .map(function(cb) { return parseInt(cb.value, 10); });
    }

    function restore() {
      const selected = getChecked();
      if (selected.length === 0) return;

      restoreBtn.disabled = true;
      restoreBtn.textContent = 'Restoring…';
      statusEl.textContent = '';

      google.script.run
        .withSuccessHandler(function() { google.script.host.close(); })
        .withFailureHandler(function(err) {
          alert('Error: ' + err.message);
          restoreBtn.disabled = false;
          restoreBtn.textContent = 'Restore Selected';
          updateState();
        })
        .restoreArchivedCompanies(selected);
    }

    function escHtml(text) {
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>